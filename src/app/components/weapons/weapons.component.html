<!-- Loading State -->
<div class="svg-loader-overlay" *ngIf="carregando">
  <div class="svg-loader">
    <svg
      fill="#000000"
      height="200px"
      width="200px"
      version="1.1"
      id="Capa_1"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 0 452.022 452.022"
      xml:space="preserve"
    >
      <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
      <g
        id="SVGRepo_tracerCarrier"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></g>
      <g id="SVGRepo_iconCarrier">
        <path
          d="M440.761,380.351l-50.512-50.512l24.481-24.481c3.905-3.905,3.905-10.237,0-14.143c-3.905-3.904-10.237-3.904-14.143,0 l-9.494,9.494l-42.368-42.368c6.562-23.401,9.894-47.59,9.894-72l-0.001-153.69c0-4.777-3.379-8.887-8.065-9.811 c-113.629-22.402-228.859-22.402-342.488,0C3.379,23.764,0,27.875,0,32.652v153.69c0,55.105,16.721,108.08,48.356,153.2 c31.635,45.119,75.739,78.897,127.545,97.681c1.101,0.399,2.255,0.599,3.409,0.599c1.154,0,2.308-0.2,3.41-0.599 c40.392-14.651,76.722-38.923,105.694-70.5l18.334,18.334l-9.494,9.494c-3.905,3.905-3.905,10.237,0,14.143 c1.953,1.953,4.512,2.929,7.071,2.929c2.559,0,5.119-0.977,7.071-2.929l24.481-24.481l50.512,50.512 c7.262,7.261,16.917,11.26,27.187,11.26s19.924-3.999,27.186-11.26c7.262-7.262,11.261-16.917,11.261-27.186 C452.022,397.268,448.023,387.613,440.761,380.351z M359.946,331.858l-3.954,3.954L162.901,142.72l45.434,3.515l168.616,168.617 L359.946,331.858z M303.621,186.342c0,8.507-0.522,16.987-1.523,25.371l-82.234-82.234c-1.687-1.687-3.921-2.715-6.3-2.899 l-76.09-5.886c-2.916-0.229-5.777,0.833-7.842,2.899c-2.065,2.065-3.124,4.93-2.899,7.842l5.886,76.09 c0.184,2.379,1.212,4.613,2.899,6.3L249.48,327.788c-19.637,21.998-43.181,39.294-70.167,51.487 c-34.45-15.596-64.093-40.179-85.924-71.304C68.275,272.143,55,230.084,55,186.342l0-110.473c82.527-15.788,166.093-15.788,248.62,0 V186.342z M179.309,417.156c-46.45-17.606-86.009-48.352-114.577-89.097C35.468,286.322,20,237.317,20,186.342l0-145.43 c105.764-19.83,212.856-19.83,318.62,0v145.43c0,18.764-2.131,37.386-6.331,55.563l-12.648-12.648 c2.637-14.044,3.979-28.452,3.979-42.915l-0.001-118.69c0-4.753-3.346-8.849-8.003-9.798c-90.445-18.438-182.167-18.438-272.614,0 C38.345,58.802,35,62.899,35,67.652v118.69c0,47.872,14.527,93.9,42.013,133.112c24.797,35.354,58.809,62.997,98.359,79.939 c1.257,0.539,2.597,0.808,3.938,0.808c1.34,0,2.68-0.269,3.937-0.808c31.01-13.282,57.997-32.593,80.394-57.444l10.618,10.618 C248.179,381.194,215.58,403.39,179.309,417.156z M152.273,202.297l-3.514-45.434l193.091,193.091l-20.96,20.959L152.273,202.297z M376.107,343.981l6.336,6.336l-15.345,36.829l-17.078-17.078L376.107,343.981z M382.392,402.44l15.345-36.829l11.178,11.178 l-15.345,36.829L382.392,402.44z M426.619,420.58L426.619,420.58c-3.483,3.484-8.116,5.403-13.043,5.403 c-1.141,0-2.262-0.114-3.361-0.315l13.994-33.585l2.41,2.41c3.484,3.484,5.403,8.116,5.403,13.043S430.103,417.096,426.619,420.58z"
        ></path>
      </g>
    </svg>
  </div>
</div>

<div class="parchment-background">
  <div class="consulta-layout">
    <h1 class="tavernatibiana-title">Capítulo das Armas Domadas</h1>

    <div class="parchment-card medieval-disclaimer">
      <button class="voltar-button-card" [routerLink]="'/grimorio'">Voltar</button>
      <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.5rem;">
        <img
          src="assets/icons-svg/arsenalweapons.svg"
          alt="Arsenal"
          class="svg-icon intro-icon"
        />
        <strong class="medieval-text">Onde o aço encontra o braço... e o treino evita tragédias.</strong>
      </div>
      <p class="medieval-intro">
        Ah, as armas! Fiéis companheiras de jornada… ou perigos ambulantes nas mãos erradas.
        Neste capítulo do grimório, registramos quais lâminas, martelos, adagas e afins tu já aprendeu a manejar sem virar motivo de piada na taverna.
      </p>
      <p class="medieval-intro">
        Aqui tu confere tua proficiência com cada arma, acompanha quais já estão sob teu domínio e quais ainda fazem teu braço doer só de olhar.
        Com um pouco de suor e umas boas porradas (de preferência nos inimigos), vais ver tua maestria crescer página por página.
      </p>
      <p class="medieval-intro">
        Porque, convenhamos: até um ogro acerta com uma clava... mas só um verdadeiro herói sabe quando, como e com estilo.
        Então bora, guerreiro! Domina teu arsenal e mostra ao mundo que tu não é só mais um que balança a espada sem saber pra onde vai!
      </p>

      <!-- Category Selection (dentro do card principal) -->
      <div class="category-section" *ngIf="!showCategoryList() && !showSavedWeapons()">
        <hr style="margin: 1.5rem 0;" />
        <h3>
          <img src="assets/icons-svg/role-playing-game.svg" alt="Espada" class="svg-icon" />
          Escolha sua Arma
        </h3>
        <div class="category-grid">
          <button 
            *ngFor="let cat of categories()" 
            (click)="onCategoryChange(cat.id)"
            class="category-btn">
            <img [src]="getCategoryIcon(cat.id)" [alt]="cat.name" class="category-icon" />
            <span>{{ cat.name }}</span>
          </button>
        </div>
      </div>

      <!-- Seção de Armas Salvas (dentro do card principal) -->
      <div class="saved-weapons-section" *ngIf="!showCategoryList() && !showSavedWeapons()">
        <hr style="margin: 1.5rem 0;" />
        <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.5rem;">
          <img src="assets/icons-svg/refine.svg" alt="Armas Domadas" class="svg-icon" />
          <strong class="medieval-text">Relíquias já conquistadas, afiadas e prontas pra briga.</strong>
        </div>
        <p class="medieval-intro">
          Aqui estão registradas as armas que tu já dominaste, bravo herói! Cada uma com história, suor e talvez um ou dois dedos perdidos no processo.
          Seja uma espada encantada, uma clava enferrujada ou aquele machado que quase caiu no próprio pé — se está aqui, é porque tu já provou que sabe usá-la (ou quase).
        </p>
        <p class="medieval-intro">
          Consulta teu arsenal com orgulho, pois são essas belezinhas que abriram caminho entre monstros, quests e vergonhas evitadas na frente da guild.
          E lembra: quem guarda bem suas armas... evita virar loot alheio!
        </p>
        <div class="saved-weapons-actions">
          <button class="button-medieval" (click)="showSavedWeaponsSection()">
            Espiar o Registro de Batalhas
          </button>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error()" class="error-message">
      <div class="parchment-card error-card">
        <h2>Erro no Arsenal</h2>
        <p>{{ error() }}</p>
        <button (click)="loadCategories()" class="retry-btn">Tentar Novamente</button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div *ngIf="!carregando && !error()" class="weapons-container">
    


    <!-- Lista de Armas Salvas -->
    <div class="saved-weapons-list-section" *ngIf="showSavedWeapons()">
      <!-- Botão Voltar -->
      <div class="back-section">
        <button class="back-btn" (click)="hideSavedWeaponsSection()">
          Voltar ao Capítulo
        </button>
      </div>

      <!-- Loading das Armas Salvas -->
      <div *ngIf="loadingSavedWeapons()" class="loading-saved">
        <div class="parchment-card">
          <h2>
            <img src="assets/icons-svg/arsenalweapons.svg" alt="Carregando" class="svg-icon rotating" />
            Carregando tuas armas domadas...
          </h2>
        </div>
      </div>

      <!-- Lista das Armas -->
      <div *ngIf="!loadingSavedWeapons()" class="parchment-card saved-weapons-list-card">
        <h2>
          <img src="assets/icons-svg/arsenalweapons.svg" alt="Armas Domadas" class="svg-icon" />
          Tuas Armas Domadas ({{ savedWeapons().length }})
        </h2>
        <hr />

        <!-- Mensagem se não há armas salvas -->
        <div *ngIf="savedWeapons().length === 0" class="no-saved-weapons">
          <div class="empty-state">
            <img src="assets/icons-svg/information.svg" alt="Vazio" class="empty-icon" />
            <h3>Nenhuma Arma Domada</h3>
            <p>Tu ainda não domaste nenhuma arma, aventureiro! Explora o arsenal e registra tuas conquistas para que a taverna lembre de tua maestria!</p>
            <button class="button-medieval" (click)="hideSavedWeaponsSection()">
              Explorar Arsenal
            </button>
          </div>
        </div>

        <!-- Grid das Armas Salvas -->
        <div *ngIf="savedWeapons().length > 0" class="saved-weapons-grid">
          <div 
            *ngFor="let savedWeapon of savedWeapons()" 
            class="saved-weapon-card"
            (click)="onSavedWeaponClick(savedWeapon)">
            <div class="saved-weapon-content">
              <div class="saved-weapon-header">
                <div class="weapon-icon">
                  <img 
                    [src]="'assets/itens/' + savedWeapon.weapon_name + '.webp'" 
                    [alt]="savedWeapon.weapon_name" 
                    class="weapon-image"
                    loading="lazy" />
                </div>
                <div class="weapon-info">
                  <h3 class="weapon-name">{{ savedWeapon.weapon_name }}</h3>
                  <p class="weapon-category">{{ weaponsService.getCategoryDisplayName(savedWeapon.weapon_category) }}</p>
                </div>
              </div>
              
              <div class="saved-weapon-details">
                <div class="saved-date">
                  <img src="assets/icons-svg/calendar.svg" alt="Data" class="detail-icon" />
                  <span>{{ formatSavedDate(savedWeapon.created_at) }}</span>
                </div>
                
                <div class="perks-count">
                  <img src="assets/icons-svg/mastery.svg" alt="Perks" class="detail-icon" />
                  <span>{{ savedWeapon.proficiency_data?.selectedPerks?.length || 0 }} níveis configurados</span>
                </div>
              </div>

              <div class="view-button">
                <span class="btn-text">Ver Proficiência</span>
                <img src="assets/icons-svg/arrow-right.svg" alt="Ver" class="arrow-icon" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botão Voltar -->
    <div class="back-section" *ngIf="showCategoryList()">
      <button class="back-btn" (click)="onBackToCategories()">
        Voltar para categorias
      </button>
    </div>

    <!-- Weapons List -->
    <div class="weapons-section" *ngIf="showCategoryList()">
      <div class="parchment-card weapons-card">
        <h2>
          <img [src]="getCategoryIcon(currentCategory())" [alt]="weaponsService.getCategoryDisplayName(currentCategory())" class="svg-icon" />
          {{ weaponsService.getCategoryDisplayName(currentCategory()) }} ({{ weapons().length }})
        </h2>
        <hr />
        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            (input)="onSearch()"
            placeholder="Buscar armas..."
            class="search-input">
        </div>
        <div *ngIf="weapons().length === 0" class="no-weapons">
          <p>Nenhuma arma encontrada com os filtros aplicados.</p>
          <p>Debug: Categoria: {{ currentCategory() }} | Total: {{ weapons().length }} | Loading: {{ loading() }} | Error: {{ error() }}</p>
        </div>
        <div class="weapons-grid">
          <div 
            *ngFor="let weapon of weapons(); trackBy: trackByWeaponName" 
            class="weapon-card"
            (click)="onWeaponClick(weapon)">
            <div class="weapon-content">
              <div class="weapon-icon">
                <img 
                  *ngIf="hasWeaponImage(weapon)" 
                  [src]="getWeaponImageUrlDirect(weapon)" 
                  [alt]="weapon.name" 
                  class="weapon-image"
                  loading="lazy"
                  (error)="onImageError($event, weapon)"
                  (load)="onImageLoad($event, weapon)" />
                <span 
                  *ngIf="!hasWeaponImage(weapon)" 
                  class="weapon-emoji">
                  {{ getWeaponImageUrl(weapon) }}
                </span>
              </div>
              <h3 class="weapon-name">{{ weapon.name }}</h3>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>
  </div>


</div> 